<!-- pos/templates/pos/nueva_compra.html -->
{% extends 'pos/base.html' %}

{% block title %}Nueva Compra - POS Zapater√≠a{% endblock %}

{% block content %}
<div class="page-header">
    <h2>üì¶ Nueva Compra a Proveedor</h2>
    <a href="{% url 'historial_compras' %}" class="btn btn-primary">üìë Ver Historial</a>
</div>

<form method="POST" id="formCompra">
    {% csrf_token %}
    
    <div class="form-group">
        <label>Proveedor *</label>
        <select name="proveedor_id" class="form-control" required>
            <option value="">Seleccionar proveedor...</option>
            {% for proveedor in proveedores %}
            <option value="{{ proveedor.id }}">{{ proveedor.nombre }} - RFC: {{ proveedor.rfc }}</option>
            {% endfor %}
        </select>
    </div>
    
    <h3 style="margin: 2rem 0 1rem; color: #667eea;">üëü Productos de la Compra</h3>
    
    <div id="productos-container">
        <div class="producto-item" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 1rem; margin-bottom: 1rem; align-items: end; padding: 1rem; background: #f9fafb; border-radius: 8px;">
            <div class="form-group" style="margin: 0;">
                <label>Producto *</label>
                <select name="producto_id[]" class="form-control producto-select" required>
                    <option value="">Seleccionar producto...</option>
                    {% for prod in productos %}
                    <option value="{{ prod.id }}" data-precio-sugerido="{{ prod.precio_compra }}">
                        {{ prod.nombre }} - {{ prod.marca }} | Talla {{ prod.talla }} | Stock actual: {{ prod.stock }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-group" style="margin: 0;">
                <label>Cantidad *</label>
                <input type="number" name="cantidad[]" class="form-control cantidad-input" min="1" value="1" required>
            </div>
            
            <div class="form-group" style="margin: 0;">
                <label>Precio Unit. *</label>
                <input type="number" step="0.01" name="precio[]" class="form-control precio-input" min="0.01" required>
            </div>
            
            <div class="form-group" style="margin: 0;">
                <label>Subtotal</label>
                <input type="text" class="form-control subtotal-display" readonly style="background: #e5e7eb; font-weight: bold;">
            </div>
            
            <button type="button" class="btn btn-danger" onclick="eliminarProducto(this)" style="margin-top: 1.5rem;">‚ùå</button>
        </div>
    </div>
    
    <button type="button" class="btn btn-success" onclick="agregarProducto()" style="margin-top: 1rem;">
        ‚ûï Agregar Otro Producto
    </button>
    
    <div class="form-group" style="margin-top: 2rem;">
        <label>Notas (Opcional)</label>
        <textarea name="notas" class="form-control" rows="3" placeholder="Observaciones sobre la compra..."></textarea>
    </div>
    
    <div style="margin-top: 2rem; padding: 2rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; color: white;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">Total de la Compra</h3>
                <p style="opacity: 0.9; font-size: 0.9rem;">Verifica los productos y precios antes de continuar</p>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 3rem; font-weight: bold;">$<span id="totalCompra">0.00</span></div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: flex-end;">
        <a href="{% url 'dashboard' %}" class="btn btn-danger">‚ùå Cancelar</a>
        <button type="submit" class="btn btn-success" style="padding: 1rem 3rem; font-size: 1.1rem;">
            üì¶ Registrar Compra
        </button>
    </div>
</form>

<script>
function agregarProducto() {
    const container = document.getElementById('productos-container');
    const item = container.children[0].cloneNode(true);
    
    // Limpiar valores
    item.querySelectorAll('input').forEach(input => {
        if (input.type === 'number') {
            input.value = input.classList.contains('cantidad-input') ? '1' : '';
        } else {
            input.value = '';
        }
    });
    item.querySelector('select').selectedIndex = 0;
    
    container.appendChild(item);
}

function eliminarProducto(btn) {
    const container = document.getElementById('productos-container');
    if (container.children.length > 1) {
        btn.closest('.producto-item').remove();
        calcularTotal();
    } else {
        alert('Debe haber al menos un producto en la compra');
    }
}

// Autocompletar precio sugerido
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('producto-select')) {
        const item = e.target.closest('.producto-item');
        const option = e.target.options[e.target.selectedIndex];
        const precioSugerido = parseFloat(option.dataset.precioSugerido) || 0;
        
        if (precioSugerido > 0) {
            item.querySelector('.precio-input').value = precioSugerido.toFixed(2);
        }
        
        calcularSubtotal(item);
    }
});

// Calcular subtotal al cambiar cantidad o precio
document.addEventListener('input', function(e) {
    if (e.target.classList.contains('cantidad-input') || e.target.classList.contains('precio-input')) {
        const item = e.target.closest('.producto-item');
        calcularSubtotal(item);
    }
});

function calcularSubtotal(item) {
    const cantidad = parseInt(item.querySelector('.cantidad-input').value) || 0;
    const precio = parseFloat(item.querySelector('.precio-input').value) || 0;
    const subtotal = cantidad * precio;
    
    item.querySelector('.subtotal-display').value = '$' + subtotal.toFixed(2);
    calcularTotal();
}

function calcularTotal() {
    let total = 0;
    document.querySelectorAll('.subtotal-display').forEach(input => {
        const valor = input.value.replace('$', '').replace(',', '');
        total += parseFloat(valor) || 0;
    });
    document.getElementById('totalCompra').textContent = total.toFixed(2);
}

// Validar formulario antes de enviar
document.getElementById('formCompra').addEventListener('submit', function(e) {
    const total = parseFloat(document.getElementById('totalCompra').textContent);
    if (total <= 0) {
        e.preventDefault();
        alert('Debe agregar al menos un producto a la compra');
        return false;
    }
    
    // Validar que todos los precios est√©n llenos
    const precios = document.querySelectorAll('.precio-input');
    for (let i = 0; i < precios.length; i++) {
        if (!precios[i].value || parseFloat(precios[i].value) <= 0) {
            e.preventDefault();
            alert('Todos los productos deben tener un precio v√°lido');
            precios[i].focus();
            return false;
        }
    }
    
    // Confirmar compra
    if (!confirm(`¬øConfirmar compra por $${total.toFixed(2)}?`)) {
        e.preventDefault();
        return false;
    }
});
</script>
{% endblock %}